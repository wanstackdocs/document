[toc]

### 1. 探针使用场景

```mermaid
graph TD;
    A[用户启动场景]-->B[调用云平台接口启动虚拟机];
    B-->C[虚拟机执行初始化脚本:下载agent,安装agent,运行agent];
    C-->D[agent采集虚拟机信息];
    D-->E[agent将信息上传到server端];
```

由于部分虚拟机对双网卡的支持有限，所以新版本agent上报数据方案改为通过修改流表的方式来实现。

wazuh方案包含server端和agent端，server端为提前起好的一个wazuh虚拟机，分配外部网络IP地址，agent端在虚拟机启动后通过初始化脚本注入到虚拟机内部。

server端与agent端需要进行双向通信。其中server端连接agent通过端口映射的方式进行连接，agent主动上报数据通过修改流表将流量直接转给server机器。

虚拟机在控制节点agent上报流程





虚拟机在计算节点agent上报流程

当有agent采集的数据要上报给server时，由于server与agent不在同一段，所以会先请求网关地址（此处需要虚拟机与网关地址能通），获取到网关后，虚拟机会将流量转发给网关设备，这时流量会首先经过br-int网桥，在br-int网桥上对流量进行识别分析出目标IP地址，如果目标IP地址为server的IP地址，则将流量的目标vlan转为外部网络的vlan，然后将流量正常转发出去。

验证步骤

在服务器上创建wazuh服务器端虚拟机

创建客户端虚拟机并安装agent

配置端口映射及流表规则

验证server与agent的通信



### 2. 方案测试

cpcloud 版本: V 版本

| 节点信息                   | 角色      | IP地址      |
| -------------------------- | --------- | ----------- |
| controller（运行计算服务） | 控制+计算 | 10.100.7.50 |
| compute                    | 计算      | 10.100.7.51 |



#### 2.1 创建网络和路由器

创建2个网络，一个为【独立网络】（创建路由器，并连接独立网络；agent端虚拟机接入独立网络），一个为【外部网络】（server端虚拟机接入外部网络）

![image-20211116172117593](探针流量上报方案测试\image-20211116172117593.png)

路由器仅连接【独立网络】

![image-20211116172231828](探针流量上报方案测试\image-20211116172231828.png)

路由器不需要配置网关，只需要关联【独立网络】



#### 2.2 创建虚拟机

分别在控制节点和计算节点创建虚拟机

![image-20211116172609036](探针流量上报方案测试\image-20211116172609036.png)

关闭端口安全【4台虚拟机端口均需要去掉】

![image-20211116172743782](探针流量上报方案测试\image-20211116172743782.png)



#### 2.3 agent和server在同一节点

> 所有流表均在agent端所在节点执行

```shell
# agnet端：  192.168.1.189  qvo899ffb14-e4 fa:16:3e:19:00:7f 
# server端： 10.100.7.140   qvob0361314-14 fa:16:3e:f3:a6:fd

# agent 端到 server端
ovs-ofctl add-flow br-int "table=0,priority=50,arp,in_port=qvo899ffb14-e4,arp_tpa=10.100.7.140,actions=mod_dl_dst:fa:16:3e:f3:a6:fd,strip_vlan,output:qvob0361314-14"

ovs-ofctl add-flow br-int "table=0,priority=50,ip,in_port=qvo899ffb14-e4,nw_dst=10.100.7.140,actions=mod_dl_dst:fa:16:3e:f3:a6:fd,strip_vlan,output:qvob0361314-14"

# 回指，server端到agent端
ovs-ofctl add-flow br-int "table=0,priority=50,arp,in_port=qvob0361314-14,arp_tpa=192.168.1.189,actions=mod_dl_dst:fa:16:3e:19:00:7f,strip_vlan,output:qvo899ffb14-e4"

ovs-ofctl add-flow br-int "table=0,priority=50,ip,in_port=qvob0361314-14,nw_dst=192.168.1.189,actions=mod_dl_dst:fa:16:3e:19:00:7f,strip_vlan,output:qvo899ffb14-e4"

```

测试效果如下图:

![image-20211116173220469](探针流量上报方案测试\image-20211116173220469.png)



#### 2.4 agent和server不在同一节点

> 所有流表均在agent端所在节点执行

```shell
# agent端:  controller  192.168.1.137  qvoedb66118-8c fa:16:3e:d6:e8:05
# server端： compute    10.100.7.140   qvob0361314-14 fa:16:3e:f3:a6:fd

# 在agent端执行，agent端 到server端 
ovs-ofctl add-flow br-int table=0,priority=50,arp,in_port=qvoedb66118-8c,arp_tpa=10.100.7.140,actions=mod_dl_dst:fa:16:3e:f3:a6:fd,mod_vlan_vid=1,output:int-br-ex

ovs-ofctl add-flow br-int table=0,priority=50,ip,in_port=qvoedb66118-8c,nw_dst=10.100.7.140,actions=mod_dl_dst:fa:16:3e:f3:a6:fd,mod_vlan_vid=1,output:int-br-ex
# 回指
ovs-ofctl add-flow br-int table=0,priority=50,arp,in_port=int-br-ex,arp_tpa=192.168.1.137,actions=mod_dl_dst:fa:16:3e:d6:e8:05,output:qvoedb66118-8c

ovs-ofctl add-flow br-int table=0,priority=50,ip,in_port=int-br-ex,nw_dst=192.168.1.137,actions=mod_dl_dst:fa:16:3e:d6:e8:05,output:qvoedb66118-8c
# 这里是br-ex
ovs-ofctl add-flow br-ex table=0,priority=50,ip,nw_src=10.100.7.140,nw_dst=192.168.1.137,actions=output:phy-br-ex
```

> vlan id=1 , agent端所在节点，虚拟机连接外部网络的qvo的VLAN ID 
>
> 具体查看:
>
> [root@controller ~]# ovs-vsctl show
> b7b08469-968f-4c9b-93f4-e506031f30f9
>     Manager "ptcp:6640:127.0.0.1"
>         is_connected: true
>     ...
>     Bridge br-int
>         Controller "tcp:127.0.0.1:6633"
>             is_connected: true
>         fail_mode: secure
>         datapath_type: system
>         Port br-int
>             Interface br-int
>                 type: internal
>         Port int-br-mirror
>             Interface int-br-mirror
>                 type: patch
>                 options: {peer=mirror-br-int}
>         Port qvoedb66118-8c
>             tag: 2
>             Interface qvoedb66118-8c  # 就是这个下面的 tag: 1 是VLAN ID=1
>         Port qvo1fa8fc62-43
>             tag: 1
>             Interface qvo1fa8fc62-43
>         ...



测试效果:

![image-20211116173959656](探针流量上报方案测试\image-20211116173959656.png)



#### 2.5 总结

上面方式存在的弊端:

> 创建的网络，地址段不允许重复，负责流表会失效



### 3. 方案改进

#### 3.1 agent端和server端同一节点

在agent端所在节点执行

```shell
# agnet端：192.168.1.189  qvo899ffb14-e4 fa:16:3e:19:00:7f 
# server端： 10.100.7.140 qvob0361314-14 fa:16:3e:f3:a6:fd

# 说明: 新增10.0.0.189 代理地址，防止agent端IP地址冲突

# 1. server端和agent在同一节点，agent端到 server端的数据流 VLAN ID转换成 server端的VLAN ID
#  agent 端到 server端 
ovs-ofctl add-flow br-int "table=0,priority=50,arp,in_port=qvo899ffb14-e4,arp_tpa=10.100.7.140,actions=mod_nw_src:10.0.0.189,mod_dl_dst:fa:16:3e:f3:a6:fd,strip_vlan,output:qvob0361314-14"

ovs-ofctl add-flow br-int "table=0,priority=50,ip,in_port=qvo899ffb14-e4,nw_dst=10.100.7.140,actions=mod_nw_src:10.0.0.189,mod_dl_dst:fa:16:3e:f3:a6:fd,strip_vlan,output:qvob0361314-14"

#  回指，server端到agent端
ovs-ofctl add-flow br-int "table=0,priority=50,arp,in_port=qvob0361314-14,arp_tpa=10.0.0.189,actions=mod_nw_dst:192.168.1.189,mod_dl_dst:fa:16:3e:19:00:7f,strip_vlan,output:qvo899ffb14-e4"

ovs-ofctl add-flow br-int "table=0,priority=50,ip,in_port=qvob0361314-14,nw_dst=10.0.0.189,actions=mod_nw_dst:192.168.1.189,mod_dl_dst:fa:16:3e:19:00:7f,strip_vlan,output:qvo899ffb14-e4"
```



#### 3.2 agent端和server端不在同一节点

在agent端所在节点执行

```shell
#  server端和agent端不在同一节点
# agent端: controller , 192.168.1.137 qvoedb66118-8c fa:16:3e:d6:e8:05   route add -net 10.100.7.0/24 eth0
# server端： compute  ， 10.100.7.140 qvob0361314-14 fa:16:3e:f3:a6:fd   route add -net 192.168.1.0/24 eth0

# 在agent端执行，agent端 到server端 
#  vlan id=1 , agent端所在节点，虚拟机连接外部网络的qvo的VLAN ID
ovs-ofctl add-flow br-int table=0,priority=50,arp,in_port=qvoedb66118-8c,arp_tpa=10.100.7.140,actions=mod_nw_src:10.0.0.137,mod_dl_dst:fa:16:3e:f3:a6:fd,mod_vlan_vid=1,output:int-br-ex

ovs-ofctl add-flow br-int table=0,priority=50,ip,in_port=qvoedb66118-8c,nw_dst=10.100.7.140,actions=mod_nw_src:10.0.0.137,mod_dl_dst:fa:16:3e:f3:a6:fd,mod_vlan_vid=1,output:int-br-ex

# 回指 

ovs-ofctl add-flow br-int table=0,priority=50,arp,in_port=int-br-ex,arp_tpa=10.0.0.137,actions=mod_nw_dst:192.168.1.137,mod_dl_dst:fa:16:3e:d6:e8:05,output:qvoedb66118-8c
# br-ex 已经把目标地址转换成了192.168.1.137，这里不能在转换了
ovs-ofctl add-flow br-int table=0,priority=50,ip,in_port=int-br-ex,nw_dst=192.168.1.137,actions=mod_dl_dst:fa:16:3e:d6:e8:05,output:qvoedb66118-8c

#  br-ex 回指
ovs-ofctl add-flow br-ex table=0,priority=50,ip,nw_src=10.100.7.140,nw_dst=10.0.0.137,actions=mod_nw_dst:192.168.1.137,output:phy-br-ex
```

方案验证和 2 相同

